name: Conan Packaging

on:
  push:
      tags: ['v1.3.2']
      branches: ["main"]
  pull_request:


jobs:
  testing:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        build_type: ["Release"]
        fpic: ["True", "False"]

    steps:
    - uses: actions/checkout@v2

    - uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: install conan
      run: |
          python3 -m pip install --upgrade pip wheel
          python3 -m pip install conan

    - name: create package
      run: >-
          conan create . astro-informatics/stable
          --build missing
          -o ssht:fPIC=${{matrix.fpic}}
          -s build_type=${{matrix.build_type}}

    - name: upload to bintray
      if: github.ref_type == 'tag'
      shell: bash
      env:
          CONAN_PASSWORD: ${{secrets.BINTRAY_TOKEN}}
          CONAN_LOGIN_USERNAME: astroinformaticsci
          CONAN_REMOTE_URL: https://api.bintray.com/conan/astro-informatics/astro-informatics

      run: |
          conan remote add astro-informatics ${CONAN_REMOTE_URL}
          conan upload ssht/1.3.2 -c --all -r=astro-informatics
