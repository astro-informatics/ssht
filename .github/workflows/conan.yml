name: Conan Packaging

on:
  push:
      branches: ["main"]
      tags:
        - 'v[0-9]+.[0-9]+.[0-9]+'
        - 'v[0-9]+.[0-9]+.[0-9]+rc[0-9]+'
  pull_request:

jobs:
  testing:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        build_type: ["Release"]
        fpic: ["True", "False"]

    steps:
    - uses: actions/checkout@v2

    - uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: install conan
      run: |
          python3 -m pip install --upgrade pip wheel
          python3 -m pip install conan

    - name: create stable package
      if: github.ref == 'refs/tags/v1.3.2'
      run: >-
          conan create . astro-informatics/stable
          --build missing
          -o ssht:fPIC=${{matrix.fpic}}
          -s build_type=${{matrix.build_type}}

    - name: create testing package
      if: github.ref != 'refs/tags/v1.3.2'
      run: >-
          conan create . astro-informatics/testing
          --build missing
          -o ssht:fPIC=${{matrix.fpic}}
          -s build_type=${{matrix.build_type}}

    - name: upload to bintray
      shell: bash
      env:
          CONAN_PASSWORD: ${{secrets.BINTRAY_TOKEN}}
          CONAN_LOGIN_USERNAME: astroinformaticsci
          CONAN_REMOTE_URL: https://api.bintray.com/conan/astro-informatics/astro-informatics

      run: |
          conan remote add astro-informatics ${CONAN_REMOTE_URL}
          conan upload ssht/1.3.2 -c --all -r=astro-informatics
